--- /psquare/developer/ANDROID/CYANOGENMOD7/frameworks/base/services/java/com/android/server/WindowManagerService.java
+++ /psquare/developer/ANDROID/CYANOGENMOD/frameworks/base/services/java/com/android/server/WindowManagerService.java
@@ -17,9 +17,9 @@
 
 package com.android.server;
 
-//import static android.view.WindowManager.MOUSE_CURSOR_NONE;
-//import static android.view.WindowManager.MOUSE_CURSOR_SURFACE;
-//import static android.view.WindowManager.MOUSE_CURSOR_OSD2;
+import static android.view.WindowManager.MOUSE_CURSOR_NONE;
+import static android.view.WindowManager.MOUSE_CURSOR_SURFACE;
+import static android.view.WindowManager.MOUSE_CURSOR_OSD2;
 import static android.view.WindowManager.LayoutParams.FIRST_APPLICATION_WINDOW;
 import static android.view.WindowManager.LayoutParams.FIRST_SUB_WINDOW;
 import static android.view.WindowManager.LayoutParams.FLAG_BLUR_BEHIND;
@@ -34,7 +34,7 @@
 import static android.view.WindowManager.LayoutParams.LAST_APPLICATION_WINDOW;
 import static android.view.WindowManager.LayoutParams.LAST_SUB_WINDOW;
 import static android.view.WindowManager.LayoutParams.MEMORY_TYPE_PUSH_BUFFERS;
-//import static android.view.WindowManager.LayoutParams.MEMORY_TYPE_NO_BLEND;
+import static android.view.WindowManager.LayoutParams.MEMORY_TYPE_NO_BLEND;
 import static android.view.WindowManager.LayoutParams.TYPE_APPLICATION_STARTING;
 import static android.view.WindowManager.LayoutParams.TYPE_BASE_APPLICATION;
 import static android.view.WindowManager.LayoutParams.TYPE_INPUT_METHOD;
@@ -42,7 +42,7 @@
 import static android.view.WindowManager.LayoutParams.TYPE_WALLPAPER;
 
 import com.android.internal.app.IBatteryStats;
-//import com.android.internal.graphics.OSD2Cursor;
+import com.android.internal.graphics.OSD2Cursor;
 import com.android.internal.policy.PolicyManager;
 import com.android.internal.policy.impl.CmPhoneWindowManager;
 import com.android.internal.policy.impl.PhoneWindowManager;
@@ -402,22 +402,22 @@
     boolean mBlurShown;
     Watermark mWatermark;
     ScreenRotationAnimation mScreenRotationAnimation;
-/*
-    //private static final int CURSOR_NONE = 0;
-    //private static final int CURSOR_GLSURFACE = 1;
-    //private static final int CURSOR_OSD2 = 2;
+
+    private static final int CURSOR_NONE = 0;
+    private static final int CURSOR_GLSURFACE = 1;
+    private static final int CURSOR_OSD2 = 2;
     private final Object mMouseCursorLock = new Object();
     private int mMouseCursorType;
     private Surface mMouseSurface = null;
     private boolean mMouseCursorShown = false;
     private int mMlx;
     private int mMly;
-    //private int mMlw;
-    //private int mMlh;
+    private int mMlw;
+    private int mMlh;
 
 	private final boolean mAutoHideCursor;
 	private final int mAutoHideCursorTimeout;
-*/
+
     int mTransactionSequence = 0;
 
     final float[] mTmpFloats = new float[9];
@@ -476,7 +476,7 @@
     Display mDisplay;
 
     H mH = new H();
-//	CursorRunable mCursorRunable = new CursorRunable();
+	CursorRunable mCursorRunable = new CursorRunable();
 
     WindowState mCurrentFocus = null;
     WindowState mLastFocus = null;
@@ -706,7 +706,7 @@
         mHoldingScreenWakeLock = pmc.newWakeLock(PowerManager.SCREEN_BRIGHT_WAKE_LOCK,
                 "KEEP_SCREEN_ON_FLAG");
         mHoldingScreenWakeLock.setReferenceCounted(false);
-/*
+
         String mouseCursorTypeStr = SystemProperties.get("ro.ui.cursor");
         if ("none".equals(mouseCursorTypeStr))
             mMouseCursorType = MOUSE_CURSOR_NONE;
@@ -717,7 +717,7 @@
 
 		mAutoHideCursor = SystemProperties.getBoolean("ro.ui.cursor.autohide", true);
 		mAutoHideCursorTimeout = SystemProperties.getInt("ro.ui.cursor.timeout", 10000);
-*/
+
         mInputManager = new InputManager(context, this);
 
         PolicyThread thr = new PolicyThread(mPolicy, this, context, pm);
@@ -2403,6 +2403,28 @@
             if (attrs != null) {
                 flagChanges = win.mAttrs.flags ^= attrs.flags;
                 attrChanges = win.mAttrs.copyFrom(attrs);
+
+                if ((attrChanges&WindowManager.LayoutParams.MEMORY_TYPE_CHANGED) != 0) {
+                    if ((attrs.memoryType == MEMORY_TYPE_NO_BLEND) |
+                        (win.mAttrs.memoryType == MEMORY_TYPE_NO_BLEND)) {
+                        /* attibute changed from/to MEMORY_TYPE_NO_BLEND */
+                        if (win.mSurface != null) {
+                            if (SHOW_TRANSACTIONS) Slog.i(TAG, ">>> OPEN TRANSACTION");
+                            Surface.openTransaction();
+                            try {
+                                if (attrs.memoryType == MEMORY_TYPE_NO_BLEND) {
+                                    win.mSurface.setFlags(Surface.NO_BLEND, Surface.NO_BLEND);
+                                }
+                                else {
+                                    win.mSurface.setFlags(0, Surface.NO_BLEND);
+                                }
+                            } finally {
+                                if (SHOW_TRANSACTIONS) Slog.i(TAG, "<<< CLOSE TRANSACTION");
+                                Surface.closeTransaction();
+                            }
+                        }
+                    }
+                }
             }
 
             if (DEBUG_LAYOUT) Slog.v(TAG, "Relayout " + win + ": " + win.mAttrs);
@@ -4669,7 +4691,7 @@
                 }
             }
             /*if (mMouseCursorType == CURSOR_OSD2)*/
-//                OSD2Cursor.setRotation((short)rotation);
+                OSD2Cursor.setRotation((short)rotation);
             for (int i=mWindows.size()-1; i>=0; i--) {
                 WindowState w = mWindows.get(i);
                 if (w.mSurface != null) {
@@ -5111,7 +5133,7 @@
      * that to config-changed listeners if appropriate.
      */
     void sendNewConfiguration() {
-//        setMouseCursorVisibility(false);
+        setMouseCursorVisibility(false);
         try {
             mActivityManager.updateConfiguration(null);
         } catch (RemoteException e) {
@@ -5528,11 +5550,9 @@
             mInputManager.setInputDispatchMode(mInputDispatchEnabled, mInputDispatchFrozen);
         }
 
-/*
         public void handleCursorMotion(int x, int y) {
             moveMouseCursor(x, y);
         }
-*/
     }
 
     public void pauseKeyDispatching(IBinder _token) {
@@ -5573,7 +5593,7 @@
             mInputMonitor.setEventDispatchingLw(enabled);
         }
     }
-/*
+
     public void moveMouseCursor(int x, int y) {
         synchronized (mMouseCursorLock) {
             if (mMlx != x || mMly != y) {
@@ -5612,7 +5632,8 @@
                     OSD2Cursor.hide();
                 mMouseCursorShown = show;
             }
-*/
+        }
+    }
 
     /**
      * Injects a keystroke event into the UI.
@@ -6498,9 +6519,9 @@
                     flags |= Surface.PUSH_BUFFERS;
                 }
 
-//                if (mAttrs.memoryType == MEMORY_TYPE_NO_BLEND) {
-//                    flags |= Surface.NO_BLEND;
-//                }
+                if (mAttrs.memoryType == MEMORY_TYPE_NO_BLEND) {
+                    flags |= Surface.NO_BLEND;
+                }
 
                 if ((mAttrs.flags&WindowManager.LayoutParams.FLAG_SECURE) != 0) {
                     flags |= Surface.SECURE;
@@ -7997,7 +8018,7 @@
             icon = _icon;
         }
     }
-/*
+
 	private final class CursorRunable implements Runnable{
 		public void run() {
             synchronized (mMouseCursorLock) {
@@ -8018,7 +8039,7 @@
 	    }
 	}
     }
-*/
+
     private final class H extends Handler {
         public static final int REPORT_FOCUS_CHANGE = 2;
         public static final int REPORT_LOSING_FOCUS = 3;
@@ -8412,7 +8433,7 @@
         }
         return false;
     }
-/*
+
     public int getMouseCursorType() {
         synchronized (mMouseCursorLock) {
             return mMouseCursorType;
@@ -8440,7 +8461,7 @@
             mMouseCursorType = type;
             return type;
         }
-*/
+    }
 
     // -------------------------------------------------------------
     // Internals
@@ -8801,7 +8822,7 @@
             mFxSession = new SurfaceSession();
             createWatermark = true;
         }
-/*
+
 	synchronized(mMouseCursorLock){
             if (mMouseCursorType == MOUSE_CURSOR_SURFACE) {
                 if(mMouseSurface == null){
@@ -8857,7 +8878,6 @@
                 mMly = dh / 2;
             }
 	}
-*/
 
 
         if (SHOW_TRANSACTIONS) Slog.i(TAG, ">>> OPEN TRANSACTION performLayoutAndPlaceSurfaces");
@@ -9900,16 +9920,27 @@
                 mBlurShown = false;
             }
 
-            // Draw the mouse cursor, if necessary
-            if (mPointerSurface != null) {
-                if (mPointerVisible) {
-                    WindowState top =
-                        (WindowState)mWindows.get(mWindows.size() - 1);
-                    mPointerSurface.setPosition(mPointerX, mPointerY);
-                    mPointerSurface.setLayer(top.mAnimLayer + 1);
-                    mPointerSurface.show();
-                } else {
-                    mPointerSurface.hide();
+	    synchronized (mMouseCursorLock) {
+                // FOURTH LOOP: Display mouse cursor Surface
+                if (mMouseCursorType == MOUSE_CURSOR_SURFACE) {
+                    synchronized (mWindowMap) {
+                        if (mMouseCursorShown) {
+                            WindowState top = (WindowState)mWindows.get(mWindows.size() - 1);
+                            try {
+                                if (DEBUG_INPUT)
+                                    Slog.i(TAG, "Move surf, x: " +
+                                           Integer.toString(mMlx) + " y:"
+                                           + Integer.toString(mMly));
+                                mMouseSurface.show();
+                                mMouseSurface.setPosition(mMlx, mMly);
+                                mMouseSurface.setLayer(top.mAnimLayer + 1);
+                            } catch (RuntimeException e) {
+                                Slog.e(TAG, "Failure showing mouse surface", e);
+                            }
+                        } else {
+                            mMouseSurface.hide();
+                        }
+		    }
                 }
             }
         } catch (RuntimeException e) {
